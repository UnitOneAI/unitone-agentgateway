# Azure Container App Configuration
# Exposes both UI and MCP on port 8080
# Note: admin server defaults to 127.0.0.1:15000 (no need to specify)
binds:
- port: 8080
  listeners:
  - name: http-listener
    protocol: HTTP
    routes:
    # Admin UI route (must come before MCP routes)
    - name: ui-route
      matches:
      - path:
          pathPrefix: /ui
      backends:
      - host: 127.0.0.1:15000

    # Admin API route (for config management)
    - name: admin-api-route
      matches:
      - path:
          pathPrefix: /config
      backends:
      - host: 127.0.0.1:15000

    # Health check route (must come before MCP routes)
    - name: health-route
      matches:
      - path:
          pathPrefix: /healthz/ready
      backends:
      - host: 127.0.0.1:15021

    # MCP routes
    - name: mcp-route
      matches:
      - path:
          pathPrefix: /mcp
      policies:
        cors:
          allowOrigins:
            - "*"
          allowHeaders:
            - mcp-protocol-version
            - content-type
            - cache-control
            - accept
          allowMethods:
            - GET
            - POST
            - OPTIONS
          allowCredentials: true
      backends:
      - mcp:
          # Security guards configuration
          securityGuards:
            # Tool Poisoning Detection Guard
            - id: tool-poisoning-detector
              enabled: true
              priority: 100
              failure_mode: fail_closed
              timeout_ms: 50
              runs_on:
                - response
              type: tool_poisoning
              strict_mode: true
              custom_patterns:
                - "(?i)SYSTEM:\\s*override"
                - "(?i)ignore\\s+all\\s+previous\\s+instructions"
                - "(?i)\\[HIDDEN\\]"
              scan_fields:
                - name
                - description
                - input_schema
              alert_threshold: 1

            # PII Detection Guard
            - id: pii-detector
              enabled: true
              priority: 50
              failure_mode: fail_closed
              timeout_ms: 100
              runs_on:
                - response
              type: pii_detection
              pii_types:
                - email_address
                - phone_number
                - social_security_number
                - credit_card_number
              confidence_threshold: 0.80
              scan_fields:
                - description
                - input_schema
              action: block

            # Rug Pull Detection Guard (monitors tool changes from any server)
            - id: rug-pull-detector
              enabled: true
              priority: 75
              failure_mode: fail_closed
              timeout_ms: 50
              runs_on:
                - response
              type: rug_pull
              risk_threshold: 5

          targets:
          # Tool Poisoning Test Server (Azure Container App - Internal)
          - name: tool-poisoning-test
            mcp:
              host: https://tool-poisoning-test-dev.internal.whitecliff-a0c9f0f7.eastus2.azurecontainerapps.io

          # PII Test Server (Azure Container App - Internal)
          - name: pii-test-server
            mcp:
              host: http://mcp-pii-test-server-dev.internal.whitecliff-a0c9f0f7.eastus2.azurecontainerapps.io:8000/mcp
