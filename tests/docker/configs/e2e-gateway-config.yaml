# E2E Test Gateway Configuration
#
# This configuration is used when running tests in Docker.
# It routes MCP requests to the mcp-test-servers container.
#
# Routes:
#   /pii-test  -> mcp-test-servers:8000 (PII test server)
#   /poison    -> mcp-test-servers:8010 (Tool poisoning test server)
#   /rug-pull  -> mcp-test-servers:8020 (Rug pull test server)
#   /rug-pull-desc   -> mcp-test-servers:8020 (Rug pull mode: description)
#   /rug-pull-schema -> mcp-test-servers:8020 (Rug pull mode: schema)
#   /rug-pull-remove -> mcp-test-servers:8020 (Rug pull mode: remove)
#   /rug-pull-add    -> mcp-test-servers:8020 (Rug pull mode: add)

binds:
- port: 8080
  listeners:
  - hostname: "*"  # Match all hosts (localhost, agentgateway, etc.)
    routes:
    # UI route
    - name: ui-route
      matches:
      - path:
          pathPrefix: /ui
      backends:
      - host: 127.0.0.1:15000

    # Admin API route
    - name: admin-api-route
      matches:
      - path:
          pathPrefix: /config
      backends:
      - host: 127.0.0.1:15000

    # PII test route - connects to PII MCP server on port 8000
    - name: pii-test
      hostnames: []
      matches:
      - path:
          pathPrefix: /pii-test
      backends:
      - mcp:
          securityGuards:
          - id: tool-poisoning
            type: tool_poisoning
            runs_on:
            - request
            - response
          - id: pii-guard
            type: pii
            runs_on:
            - request
            - response
            - tool_invoke
            detect:
            - email
            - credit_card
            - ssn
            - phone_number
            action: mask
          targets:
          - name: pii-mcp
            mcp:
              host: http://mcp-test-servers:8000/mcp
          statefulMode: stateful
      policies:
        cors:
          allowCredentials: false
          allowHeaders:
          - '*'
          allowMethods:
          - '*'
          allowOrigins:
          - '*'
          exposeHeaders:
          - mcp-session-id
          maxAge: null

    # Tool poisoning test route - connects to port 8010
    - name: tool-poisoning
      hostnames: []
      matches:
      - path:
          pathPrefix: /poison
      backends:
      - mcp:
          securityGuards:
          - id: tool-poisoning
            type: tool_poisoning
            runs_on:
            - request
            - response
          targets:
          - name: poison
            mcp:
              host: http://mcp-test-servers:8010/mcp
          statefulMode: stateful
      policies:
        cors:
          allowCredentials: false
          allowHeaders:
          - '*'
          allowMethods:
          - '*'
          allowOrigins:
          - '*'
          exposeHeaders:
          - mcp-session-id
          maxAge: null

    # Rug pull test route - connects to port 8020
    - name: rug-pull
      hostnames: []
      matches:
      - path:
          pathPrefix: /rug-pull
      backends:
      - mcp:
          securityGuards:
          - id: rug-pull
            type: rug_pull
            runs_on:
            - response
            risk_threshold: 5
          targets:
          - name: rug-pull
            mcp:
              host: http://mcp-test-servers:8020/mcp
          statefulMode: stateful
      policies:
        cors:
          allowCredentials: false
          allowHeaders:
          - '*'
          allowMethods:
          - '*'
          allowOrigins:
          - '*'
          exposeHeaders:
          - mcp-session-id
          maxAge: null

    # Rug pull mode-specific routes (separate target names for isolated baselines)
    - name: rug-pull-desc
      matches:
      - path:
          pathPrefix: /rug-pull-desc
      backends:
      - mcp:
          securityGuards:
          - id: rug-pull-desc
            type: rug_pull
            runs_on: [response]
            risk_threshold: 5
          targets:
          - name: rug-pull-desc
            mcp:
              host: http://mcp-test-servers:8020/mcp
          statefulMode: stateful

    - name: rug-pull-schema
      matches:
      - path:
          pathPrefix: /rug-pull-schema
      backends:
      - mcp:
          securityGuards:
          - id: rug-pull-schema
            type: rug_pull
            runs_on: [response]
            risk_threshold: 5
          targets:
          - name: rug-pull-schema
            mcp:
              host: http://mcp-test-servers:8020/mcp
          statefulMode: stateful

    - name: rug-pull-remove
      matches:
      - path:
          pathPrefix: /rug-pull-remove
      backends:
      - mcp:
          securityGuards:
          - id: rug-pull-remove
            type: rug_pull
            runs_on: [response]
            risk_threshold: 5
          targets:
          - name: rug-pull-remove
            mcp:
              host: http://mcp-test-servers:8020/mcp
          statefulMode: stateful

    - name: rug-pull-add
      matches:
      - path:
          pathPrefix: /rug-pull-add
      backends:
      - mcp:
          securityGuards:
          - id: rug-pull-add
            type: rug_pull
            runs_on: [response]
            risk_threshold: 5
          targets:
          - name: rug-pull-add
            mcp:
              host: http://mcp-test-servers:8020/mcp
          statefulMode: stateful
